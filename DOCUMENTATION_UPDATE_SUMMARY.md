# üìä –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç—É Modern Telegram Bot
## –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: 2 –∞–≤–≥—É—Å—Ç–∞ 2025

## ‚úÖ –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞

### üéØ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–ø–∏–π –±–æ—Ç–∞ —Ä–∞–±–æ—Ç–∞–ª–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **–†–µ—à–µ–Ω–∏–µ**: –ù–∞–π–¥–µ–Ω—ã –∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞–ø—É—â–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∫–æ–ø–∏—è –±–æ—Ç–∞ (PID 96547)

### ü§ñ –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞
- **–°–æ—Å—Ç–æ—è–Ω–∏–µ**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- **–ü—Ä–æ—Ü–µ—Å—Å**: `/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/Resources/Python.app/Contents/MacOS/Python -m app.main`
- **PID**: 96547
- **–†–µ–∂–∏–º**: Development
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

### üóÑÔ∏è –°—Ç–∞—Ç—É—Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- **PostgreSQL**: ‚úÖ –ó–∞–ø—É—â–µ–Ω (localhost:5432)
- **Redis**: ‚úÖ –ó–∞–ø—É—â–µ–Ω (localhost:6379)
- **Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã**: ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: .env –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### ‚ö†Ô∏è –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
1. **–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è callback queries**
   - **–ü—Ä–æ–±–ª–µ–º–∞**: `telegram_message_id` —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è BIGINT
   - **–û—à–∏–±–∫–∞**: `'123675934757799139' ('str' object cannot be interpreted as an integer)`
   - **–í–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ**: –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç
   - **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ù–∏–∑–∫–∏–π

### üî® –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é
1. **–ò–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø –ø–æ–ª—è telegram_message_id**
   ```sql
   ALTER TABLE message_logs ALTER COLUMN telegram_message_id TYPE VARCHAR(50);
   ```
   
2. **–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é Alembic**
   ```bash
   alembic revision -m "Fix telegram_message_id type"
   alembic upgrade head
   ```

## üöÄ –£—Å–ø–µ—à–Ω–æ —Ä–∞–±–æ—Ç–∞—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### ‚úÖ –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–¥–º–∏–Ω–æ–≤ ‚úÖ
- –ö–æ–º–∞–Ω–¥—ã `/start`, `/help`, `/profile`, `/ping` ‚úÖ
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL ‚úÖ
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Redis ‚úÖ
- Middleware –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚úÖ

### ‚úÖ –ú–æ–¥—É–ª—å –∂—É—Ä–Ω–∞–ª–∞ —Ä–∞–±–æ—Ç **[–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–í–ï–†–®–ï–ù]**
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π ‚úÖ
- –ü–æ—à–∞–≥–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏ ‚úÖ
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π ‚úÖ
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞—Ç–µ–ª—è –∑–∞–ø–∏—Å–∏ ‚úÖ
- –°–∏—Å—Ç–µ–º–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π ‚úÖ
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚úÖ
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏ ‚úÖ
- –ö–æ–º–∞–Ω–¥—ã `/journal`, `/history`, `/report` ‚úÖ

### üîó –ì–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- n8n webhook —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚úÖ
- Google Sheets –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ ‚úÖ
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã ‚úÖ

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–æ–±–Ω–æ–≤–ª–µ–Ω–∞)
- **–§–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: 18
- **–û—Å–Ω–æ–≤–Ω—ã—Ö —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤**: 5
- **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π**: 3
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –≥–∞–π–¥–æ–≤**: 4
- **–û–±—â–∏–π –æ–±—ä–µ–º**: >2000 —Å—Ç—Ä–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞
```
app/
‚îú‚îÄ‚îÄ main.py                      # ‚úÖ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
‚îú‚îÄ‚îÄ config.py                    # ‚úÖ Pydantic –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ database.py             # ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚îÇ   ‚îî‚îÄ‚îÄ models.py               # ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ telegram_message_id
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ start.py                # ‚úÖ –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç
‚îÇ   ‚îî‚îÄ‚îÄ work_journal.py         # ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ auth.py                 # ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
‚îÇ   ‚îî‚îÄ‚îÄ logging.py              # ‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å –±–æ–ª—å—à–∏–º–∏ ID
‚îî‚îÄ‚îÄ services/                   # ‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã
```

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π)
1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**
   - –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø –ø–æ–ª—è `telegram_message_id` –Ω–∞ VARCHAR
   - –°–æ–∑–¥–∞—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ —Ü–µ–ª–∏ (1-2 –Ω–µ–¥–µ–ª–∏)
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å n8n workflow**
   - –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è webhook
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Google Sheets –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –¥–∞–Ω–Ω—ã—Ö

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏**
   - –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ —Ü–µ–ª–∏ (1-2 –º–µ—Å—è—Ü–∞)
4. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏**
   - –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –æ—Ç—á–µ—Ç–æ–≤
   - –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

5. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤
   - –£–ª—É—á—à–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤

## üõ†Ô∏è –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞
ps aux | grep "app.main" | grep -v grep

# –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö  
make status

# –õ–æ–≥–∏ —Ç–µ–∫—É—â–µ–≥–æ –±–æ—Ç–∞
tail -f logs/bot.log

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
make db-shell
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```bash
# 1. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
cd /Users/zardes/Projects/tg-mordern-bot
source venv/bin/activate
alembic revision -m "Fix telegram_message_id type to VARCHAR"

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic upgrade head

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å (Ctrl+C)
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
make bot-dev
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞
```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail -f logs/*.log

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ
make db-shell
\dt  # —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü
SELECT * FROM message_logs LIMIT 5;

# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
top -pid 96547  # –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±–æ—Ç–∞
```

## üìã Checklist –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º

### ‚úÖ –ì–æ—Ç–æ–≤–æ
- [x] –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã
- [x] –ú–æ–¥—É–ª—å –∂—É—Ä–Ω–∞–ª–∞ —Ä–∞–±–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ –∏ –ø–æ–ª–Ω–∞—è
- [x] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞

### ‚è≥ –í —Ä–∞–±–æ—Ç–µ
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è callback queries
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å n8n workflow
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Google Sheets –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
- [ ] –ü—Ä–æ–≤