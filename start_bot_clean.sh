#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

echo "ü§ñ –ó–∞–ø—É—Å–∫ HHIVP IT Assistant Bot (Development)"
echo "=========================================="

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")"

# –£–±–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
echo "üî™ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–∞..."
pkill -f "python.*app\.main" 2>/dev/null || true
pkill -f "app\.main" 2>/dev/null || true
pkill -f "hhivp" 2>/dev/null || true

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
sleep 2

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
if pgrep -f "app\.main" > /dev/null; then
    echo "‚ùå –ù–∞–π–¥–µ–Ω—ã –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞:"
    ps aux | grep "app\.main" | grep -v grep
    echo "–£–±–∏–≤–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ..."
    pkill -9 -f "app\.main" 2>/dev/null || true
    sleep 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
if ! docker ps | grep -q "telegram-bot-postgres"; then
    echo "‚ùå PostgreSQL –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å–∫–∞–µ–º..."
    make db-up
    sleep 3
fi

if ! docker ps | grep -q "telegram-bot-redis"; then
    echo "‚ùå Redis –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å–∫–∞–µ–º..."
    make db-up
    sleep 3
fi

echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞"

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
echo "üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
echo "   Telegram: @hhivp_it_bot"
echo "   –†–µ–∂–∏–º: Development (–ª–æ–∫–∞–ª—å–Ω–æ)"
echo "   –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: Docker (PostgreSQL + Redis)"
echo ""
echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo "=========================================="

# –ó–∞–ø—É—Å–∫ —Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–º venv
source venv/bin/activate && python -m app.main
