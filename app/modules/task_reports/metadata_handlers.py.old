"""
Task Reports Metadata Handlers - Collecting work metadata (duration, type, company, workers)
"""

import json
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import StateFilter
from aiogram.fsm.context import FSMContext

from .states import TaskReportStates
from ...database.database import get_async_session
from ...services.task_reports_service import task_reports_service
from ...utils.logger import bot_logger
from ...integrations.plane import plane_api


router = Router(name="task_reports_metadata")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CALLBACK: AGREE TO TEXT (when autofilled)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.callback_query(F.data.startswith("agree_text:"))
async def callback_agree_text(callback: CallbackQuery, state: FSMContext):
    """
    Admin agrees with autofilled text, move to metadata collection
    """
    try:
        task_report_id = int(callback.data.split(":")[1])
        bot_logger.info(f"âœ… Admin {callback.from_user.id} agreed with text for report #{task_report_id}")

        # Move to duration collection
        await state.set_state(TaskReportStates.filling_duration)
        await state.update_data(task_report_id=task_report_id)

        await callback.message.edit_text(
            f"âœ… **Ğ¢ĞµĞºÑÑ‚ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ° ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½!**\n\n"
            f"Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ğ¼ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹.\n\n"
            f"â±ï¸ **Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹**\n"
            f"ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹: `2h`, `4h`, `1.5h`, `30m`",
            parse_mode="Markdown"
        )

        await callback.answer()

    except Exception as e:
        bot_logger.error(f"âŒ Error in agree_text callback: {e}")
        await callback.answer("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°", show_alert=True)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TEXT HANDLER: DURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.message(StateFilter(TaskReportStates.filling_duration), F.text)
async def handle_duration(message: Message, state: FSMContext):
    """
    Admin sends work duration (e.g., "2h", "4h")
    """
    try:
        duration = message.text.strip()

        # Simple validation
        if not any(char in duration.lower() for char in ['h', 'm']):
            await message.reply(
                "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸.\n\n"
                "ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹: `2h`, `4h`, `1.5h`, `30m`",
                parse_mode="Markdown"
            )
            return

        # Save to state
        await state.update_data(work_duration=duration)
        bot_logger.info(f"âœ… Duration saved: {duration}")

        # Move to work type selection
        await state.set_state(TaskReportStates.filling_work_type)

        await message.reply(
            f"âœ… Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: **{duration}**\n\n"
            f"ğŸš— **Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ğ¸Ğ¿ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:**",
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="ğŸš— Ğ’Ñ‹ĞµĞ·Ğ´", callback_data="work_type:travel")],
                [InlineKeyboardButton(text="ğŸ’» Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ğ¾", callback_data="work_type:remote")]
            ])
        )

    except Exception as e:
        bot_logger.error(f"âŒ Error handling duration: {e}")
        await message.reply("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CALLBACK: WORK TYPE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.callback_query(F.data.startswith("work_type:"))
async def callback_work_type(callback: CallbackQuery, state: FSMContext):
    """
    Admin selects work type (travel/remote)
    """
    try:
        work_type = callback.data.split(":")[1]
        is_travel = (work_type == "travel")

        # Save to state
        await state.update_data(is_travel=is_travel)
        bot_logger.info(f"âœ… Work type saved: {'Ğ’Ñ‹ĞµĞ·Ğ´' if is_travel else 'Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ğ¾'}")

        # Get task report to fetch company from Plane
        state_data = await state.get_data()
        task_report_id = state_data.get("task_report_id")

        if not task_report_id:
            await callback.answer("âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ ID Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°", show_alert=True)
            return

        async for session in get_async_session():
            task_report = await task_reports_service.get_task_report(session, task_report_id)

            if not task_report:
                await callback.answer("âŒ ĞÑ‚Ñ‡Ñ‘Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", show_alert=True)
                return

            # Fetch project name from Plane
            try:
                project_data = await plane_api.get_project(task_report.plane_project_id)
                suggested_company = project_data.get("name", "")
                bot_logger.info(f"âœ… Fetched project name from Plane: {suggested_company}")
            except Exception as e:
                bot_logger.warning(f"âš ï¸ Failed to fetch project from Plane: {e}")
                suggested_company = ""

            # Move to company input
            await state.set_state(TaskReportStates.filling_company)

            if suggested_company:
                await callback.message.edit_text(
                    f"âœ… Ğ¢Ğ¸Ğ¿ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹: **{'ğŸš— Ğ’Ñ‹ĞµĞ·Ğ´' if is_travel else 'ğŸ’» Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ğ¾'}**\n\n"
                    f"ğŸ¢ **Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ**\n"
                    f"ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¸Ğ· Plane: `{suggested_company}`\n\n"
                    f"ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ Ğ¸Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ:",
                    parse_mode="Markdown",
                    reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                        [InlineKeyboardButton(
                            text=f"âœ… {suggested_company}",
                            callback_data=f"use_company:{suggested_company}"
                        )]
                    ])
                )
            else:
                await callback.message.edit_text(
                    f"âœ… Ğ¢Ğ¸Ğ¿ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹: **{'ğŸš— Ğ’Ñ‹ĞµĞ·Ğ´' if is_travel else 'ğŸ’» Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ğ¾'}**\n\n"
                    f"ğŸ¢ **Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ**\n"
                    f"ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸:",
                    parse_mode="Markdown"
                )

            await callback.answer()

    except Exception as e:
        bot_logger.error(f"âŒ Error in work_type callback: {e}")
        await callback.answer("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°", show_alert=True)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CALLBACK: USE SUGGESTED COMPANY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.callback_query(F.data.startswith("use_company:"))
async def callback_use_company(callback: CallbackQuery, state: FSMContext):
    """
    Admin uses suggested company name from Plane project
    """
    try:
        company_name = callback.data.replace("use_company:", "")

        # Save and move to workers
        await state.update_data(company=company_name)
        bot_logger.info(f"âœ… Company saved: {company_name}")

        # Get task report to fetch assignees from Plane
        state_data = await state.get_data()
        task_report_id = state_data.get("task_report_id")

        async for session in get_async_session():
            task_report = await task_reports_service.get_task_report(session, task_report_id)

            if not task_report:
                await callback.answer("âŒ ĞÑ‚Ñ‡Ñ‘Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", show_alert=True)
                return

            # Fetch assignees from Plane task
            try:
                issue_data = await plane_api.get_issue(
                    task_report.plane_project_id,
                    task_report.plane_issue_id
                )
                assignees = issue_data.get("assignees", [])
                suggested_workers = []

                # Get display names from assignee IDs
                for assignee_id in assignees:
                    try:
                        member = await plane_api.get_workspace_member(assignee_id)
                        display_name = member.get("member", {}).get("display_name")
                        if display_name:
                            suggested_workers.append(display_name)
                    except Exception as e:
                        bot_logger.warning(f"âš ï¸ Failed to fetch assignee {assignee_id}: {e}")

                workers_text = ", ".join(suggested_workers) if suggested_workers else ""
                bot_logger.info(f"âœ… Fetched assignees from Plane: {workers_text}")

            except Exception as e:
                bot_logger.warning(f"âš ï¸ Failed to fetch assignees from Plane: {e}")
                workers_text = ""

            # Move to workers input
            await state.set_state(TaskReportStates.filling_workers)

            if workers_text:
                await callback.message.edit_text(
                    f"âœ… ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ: **{company_name}**\n\n"
                    f"ğŸ‘¥ **Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ĞµĞ¹**\n"
                    f"ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¸Ğ· Plane: `{workers_text}`\n\n"
                    f"ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¸Ğ¼ĞµĞ½Ğ° Ñ‡ĞµÑ€ĞµĞ· Ğ·Ğ°Ğ¿ÑÑ‚ÑƒÑ Ğ¸Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ:",
                    parse_mode="Markdown",
                    reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                        [InlineKeyboardButton(
                            text=f"âœ… {workers_text}",
                            callback_data=f"use_workers:{workers_text}"
                        )]
                    ])
                )
            else:
                await callback.message.edit_text(
                    f"âœ… ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ: **{company_name}**\n\n"
                    f"ğŸ‘¥ **Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ĞµĞ¹**\n"
                    f"ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¸Ğ¼ĞµĞ½Ğ° Ñ‡ĞµÑ€ĞµĞ· Ğ·Ğ°Ğ¿ÑÑ‚ÑƒÑ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ˜Ğ²Ğ°Ğ½, ĞŸÑ‘Ñ‚Ñ€):",
                    parse_mode="Markdown"
                )

            await callback.answer()

    except Exception as e:
        bot_logger.error(f"âŒ Error in use_company callback: {e}")
        await callback.answer("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°", show_alert=True)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TEXT HANDLER: COMPANY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.message(StateFilter(TaskReportStates.filling_company), F.text)
async def handle_company(message: Message, state: FSMContext):
    """
    Admin manually enters company name
    """
    try:
        company = message.text.strip()

        # Save and move to workers
        await state.update_data(company=company)
        bot_logger.info(f"âœ… Company saved: {company}")

        # Fetch assignees from Plane (same logic as use_company callback)
        state_data = await state.get_data()
        task_report_id = state_data.get("task_report_id")

        async for session in get_async_session():
            task_report = await task_reports_service.get_task_report(session, task_report_id)

            if not task_report:
                await message.reply("âŒ ĞÑ‚Ñ‡Ñ‘Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
                return

            # Fetch assignees
            try:
                issue_data = await plane_api.get_issue(
                    task_report.plane_project_id,
                    task_report.plane_issue_id
                )
                assignees = issue_data.get("assignees", [])
                suggested_workers = []

                for assignee_id in assignees:
                    try:
                        member = await plane_api.get_workspace_member(assignee_id)
                        display_name = member.get("member", {}).get("display_name")
                        if display_name:
                            suggested_workers.append(display_name)
                    except:
                        pass

                workers_text = ", ".join(suggested_workers) if suggested_workers else ""
            except:
                workers_text = ""

            # Move to workers
            await state.set_state(TaskReportStates.filling_workers)

            if workers_text:
                await message.reply(
                    f"âœ… ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ: **{company}**\n\n"
                    f"ğŸ‘¥ **Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ĞµĞ¹**\n"
                    f"ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¸Ğ· Plane: `{workers_text}`\n\n"
                    f"ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¸Ğ¼ĞµĞ½Ğ° Ñ‡ĞµÑ€ĞµĞ· Ğ·Ğ°Ğ¿ÑÑ‚ÑƒÑ Ğ¸Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ:",
                    parse_mode="Markdown",
                    reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                        [InlineKeyboardButton(
                            text=f"âœ… {workers_text}",
                            callback_data=f"use_workers:{workers_text}"
                        )]
                    ])
                )
            else:
                await message.reply(
                    f"âœ… ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ: **{company}**\n\n"
                    f"ğŸ‘¥ **Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ĞµĞ¹**\n"
                    f"ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¸Ğ¼ĞµĞ½Ğ° Ñ‡ĞµÑ€ĞµĞ· Ğ·Ğ°Ğ¿ÑÑ‚ÑƒÑ:",
                    parse_mode="Markdown"
                )

    except Exception as e:
        bot_logger.error(f"âŒ Error handling company: {e}")
        await message.reply("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CALLBACK: USE SUGGESTED WORKERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.callback_query(F.data.startswith("use_workers:"))
async def callback_use_workers(callback: CallbackQuery, state: FSMContext):
    """
    Admin uses suggested workers from Plane assignees
    """
    try:
        workers_text = callback.data.replace("use_workers:", "")
        workers_list = [w.strip() for w in workers_text.split(",")]

        # Save workers as JSON array
        await state.update_data(workers=json.dumps(workers_list))
        bot_logger.info(f"âœ… Workers saved: {workers_list}")

        # All metadata collected - save to DB and show preview
        await save_metadata_and_show_preview(callback, state, is_callback=True)

    except Exception as e:
        bot_logger.error(f"âŒ Error in use_workers callback: {e}")
        await callback.answer("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°", show_alert=True)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TEXT HANDLER: WORKERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.message(StateFilter(TaskReportStates.filling_workers), F.text)
async def handle_workers(message: Message, state: FSMContext):
    """
    Admin manually enters workers list
    """
    try:
        workers_text = message.text.strip()
        workers_list = [w.strip() for w in workers_text.split(",")]

        # Save workers as JSON array
        await state.update_data(workers=json.dumps(workers_list))
        bot_logger.info(f"âœ… Workers saved: {workers_list}")

        # All metadata collected - save to DB and show preview
        await save_metadata_and_show_preview(message, state, is_callback=False)

    except Exception as e:
        bot_logger.error(f"âŒ Error handling workers: {e}")
        await message.reply("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HELPER: SAVE METADATA AND SHOW PREVIEW
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def save_metadata_and_show_preview(event, state: FSMContext, is_callback: bool):
    """
    Save all metadata to DB and show final preview
    """
    try:
        state_data = await state.get_data()
        task_report_id = state_data.get("task_report_id")
        work_duration = state_data.get("work_duration")
        is_travel = state_data.get("is_travel")
        company = state_data.get("company")
        workers = state_data.get("workers")

        if not task_report_id:
            if is_callback:
                await event.answer("âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ ID Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°", show_alert=True)
            else:
                await event.reply("âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ ID Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°")
            return

        # Save metadata to DB
        async for session in get_async_session():
            # Update task report with metadata
            task_report = await task_reports_service.get_task_report(session, task_report_id)

            if not task_report:
                if is_callback:
                    await event.answer("âŒ ĞÑ‚Ñ‡Ñ‘Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", show_alert=True)
                else:
                    await event.reply("âŒ ĞÑ‚Ñ‡Ñ‘Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
                return

            # Update metadata fields
            task_report.work_duration = work_duration
            task_report.is_travel = is_travel
            task_report.company = company
            task_report.workers = workers
            await session.commit()
            await session.refresh(task_report)

            bot_logger.info(
                f"âœ… Metadata saved for report #{task_report_id}: "
                f"duration={work_duration}, travel={is_travel}, company={company}, workers={workers}"
            )

            # Move to review state
            await state.set_state(TaskReportStates.reviewing_report)

            # Parse workers list for display
            try:
                workers_list = json.loads(workers)
                workers_display = ", ".join(workers_list)
            except:
                workers_display = workers

            # Show final preview
            preview_text = f"""
âœ… **ĞÑ‚Ñ‡Ñ‘Ñ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ!**

ğŸ“‹ **Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°:** #{task_report.plane_sequence_id}

**ĞœĞ•Ğ¢ĞĞ”ĞĞĞĞ«Ğ• Ğ ĞĞ‘ĞĞ¢Ğ«:**
â±ï¸ Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: **{work_duration}**
ğŸš— Ğ¢Ğ¸Ğ¿ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹: **{'Ğ’Ñ‹ĞµĞ·Ğ´' if is_travel else 'Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ğ¾'}**
ğŸ¢ ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ: **{company}**
ğŸ‘¥ Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ğ¸: **{workers_display}**

**ĞĞ¢Ğ§ĞĞ¢ Ğ”Ğ›Ğ¯ ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ:**
{task_report.report_text[:500]}{"..." if len(task_report.report_text or "") > 500 else ""}

_ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ¢ĞĞ›Ğ¬ĞšĞ Ñ‚ĞµĞºÑÑ‚ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ° (Ğ±ĞµĞ· Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)_
"""

            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(
                    text="âœ… ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ",
                    callback_data=f"send_report:{task_report_id}"
                )],
                [InlineKeyboardButton(
                    text="âœï¸ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ",
                    callback_data=f"edit_report:{task_report_id}"
                )],
                [InlineKeyboardButton(
                    text="âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ",
                    callback_data=f"cancel_report:{task_report_id}"
                )]
            ])

            if is_callback:
                await event.message.edit_text(preview_text, parse_mode="Markdown", reply_markup=keyboard)
                await event.answer()
            else:
                await event.reply(preview_text, parse_mode="Markdown", reply_markup=keyboard)

    except Exception as e:
        bot_logger.error(f"âŒ Error saving metadata and showing preview: {e}")
        if is_callback:
            await event.answer("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°", show_alert=True)
        else:
            await event.reply("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CALLBACK: EDIT INDIVIDUAL FIELD
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.callback_query(F.data.startswith("edit_field:"))
async def callback_edit_field(callback: CallbackQuery, state: FSMContext):
    """
    Handle editing individual fields from edit menu
    Format: edit_field:{field_name}:{task_report_id}
    """
    try:
        parts = callback.data.split(":")
        field_name = parts[1]
        task_report_id = int(parts[2])

        bot_logger.info(f"ğŸ“ Admin {callback.from_user.id} editing field '{field_name}' for report #{task_report_id}")

        await state.update_data(task_report_id=task_report_id)

        if field_name == "text":
            # Edit report text
            await state.set_state(TaskReportStates.filling_report)
            await callback.message.edit_text(
                "ğŸ“ **Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°**\n\n"
                "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°:",
                parse_mode="Markdown",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(
                        text="â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´",
                        callback_data=f"edit_report:{task_report_id}"
                    )]
                ])
            )

        elif field_name == "duration":
            # Edit duration
            await state.set_state(TaskReportStates.filling_duration)
            await callback.message.edit_text(
                "â±ï¸ **Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹**\n\n"
                "Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹\n"
                "ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹: `2h`, `4h`, `1.5h`, `30m`",
                parse_mode="Markdown",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(
                        text="â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´",
                        callback_data=f"edit_report:{task_report_id}"
                    )]
                ])
            )

        elif field_name == "work_type":
            # Edit work type
            await state.set_state(TaskReportStates.filling_work_type)
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(
                    text="ğŸš— Ğ’Ñ‹ĞµĞ·Ğ´",
                    callback_data=f"set_travel:yes:{task_report_id}"
                )],
                [InlineKeyboardButton(
                    text="ğŸ’» Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ğ¾",
                    callback_data=f"set_travel:no:{task_report_id}"
                )],
                [InlineKeyboardButton(
                    text="â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´",
                    callback_data=f"edit_report:{task_report_id}"
                )]
            ])
            await callback.message.edit_text(
                "ğŸš— **Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ¸Ğ¿Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹**\n\n"
                "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ğ¸Ğ¿ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:",
                parse_mode="Markdown",
                reply_markup=keyboard
            )

        elif field_name == "company":
            # Edit company
            await state.set_state(TaskReportStates.filling_company)
            await callback.message.edit_text(
                "ğŸ¢ **Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸**\n\n"
                "Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸:",
                parse_mode="Markdown",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(
                        text="â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´",
                        callback_data=f"edit_report:{task_report_id}"
                    )]
                ])
            )

        elif field_name == "workers":
            # Edit workers
            await state.set_state(TaskReportStates.filling_workers)
            await callback.message.edit_text(
                "ğŸ‘¥ **Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ĞµĞ¹**\n\n"
                "Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ĞµĞ¹ Ñ‡ĞµÑ€ĞµĞ· Ğ·Ğ°Ğ¿ÑÑ‚ÑƒÑ\n"
                "ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: `Ğ˜Ğ²Ğ°Ğ½ Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ², ĞŸÑ‘Ñ‚Ñ€ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²`",
                parse_mode="Markdown",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(
                        text="â—€ï¸ ĞĞ°Ğ·Ğ°Ğ´",
                        callback_data=f"edit_report:{task_report_id}"
                    )]
                ])
            )

        await callback.answer()

    except Exception as e:
        bot_logger.error(f"âŒ Error in edit_field callback: {e}")
        await callback.answer("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°", show_alert=True)


# Handler for set_travel callback from edit menu
@router.callback_query(F.data.startswith("set_travel:"))
async def callback_set_travel(callback: CallbackQuery, state: FSMContext):
    """Set travel type from edit menu"""
    try:
        parts = callback.data.split(":")
        is_travel = parts[1] == "yes"
        task_report_id = int(parts[2])

        async for session in get_async_session():
            task_report = await task_reports_service.get_task_report(session, task_report_id)
            if task_report:
                task_report.is_travel = is_travel
                await session.commit()

                # Return to edit menu
                await callback.answer(f"âœ… Ğ¢Ğ¸Ğ¿ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹: {'Ğ’Ñ‹ĞµĞ·Ğ´' if is_travel else 'Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ğ¾'}")
                # Trigger edit_report to refresh menu
                callback.data = f"edit_report:{task_report_id}"
                from .handlers import callback_edit_report
                await callback_edit_report(callback, state)

    except Exception as e:
        bot_logger.error(f"âŒ Error in set_travel callback: {e}")
        await callback.answer("âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°", show_alert=True)
