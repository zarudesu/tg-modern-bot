"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –º–æ–¥—É–ª—è –∂—É—Ä–Ω–∞–ª–∞ —Ä–∞–±–æ—Ç
"""
from datetime import date, datetime, timedelta
from typing import Optional, Union, Tuple
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update, delete, func, and_, or_, desc

from ..database.database import get_async_session
from ..database.models import BotUser
from ..database.work_journal_models import WorkJournalEntry, WorkJournalCompany
from ..services.work_journal_service import WorkJournalService
from ..services.n8n_integration_service import N8nIntegrationService
from ..utils.work_journal_constants import (
    WorkJournalState, 
    CallbackAction, 
    EMOJI,
    MESSAGE_TEMPLATES
)
from ..utils.work_journal_keyboards import (
    parse_callback_data,
    create_date_selection_keyboard,
    create_company_selection_keyboard,
    create_duration_selection_keyboard,
    create_travel_selection_keyboard,
    create_worker_selection_keyboard,
    create_confirmation_keyboard,
    create_description_keyboard,
    create_description_input_keyboard,
    create_continue_keyboard,
    create_history_menu_keyboard,
    create_report_menu_keyboard,
    create_back_cancel_keyboard,
    build_callback_data
)
from ..utils.work_journal_formatters import (
    escape_markdown_v2,
    format_date_for_display,
    format_draft_confirmation,
    format_error_message,
    format_success_message,
    format_entries_list,
    format_statistics_report,
    format_help_message
)
from ..utils.logger import bot_logger, log_user_action
from sqlalchemy import select

router = Router()


async def get_user_email(session: AsyncSession, telegram_user_id: int) -> Optional[str]:
    """–ü–æ–ª—É—á–∏—Ç—å email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    result = await session.execute(
        select(BotUser).where(BotUser.telegram_user_id == telegram_user_id)
    )
    user = result.scalar_one_or_none()
    
    if user and user.username:
        return f"{user.username}@example.com"  # –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç email
    
    return f"user_{telegram_user_id}@telegram.bot"


@router.message(Command("journal", "work_journal"))
async def start_journal_entry(message: Message):
    """–ù–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª–µ —Ä–∞–±–æ—Ç"""
    try:
        user_id = message.from_user.id
        log_user_action(user_id, "start_journal")
        
        async for session in get_async_session():
            service = WorkJournalService(session)
            
            # –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ
            await service.set_user_state(
                user_id,
                WorkJournalState.SELECTING_DATE,
                draft_date=date.today()  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            start_text = (
                f"{MESSAGE_TEMPLATES['start_entry']}\n\n"
                f"{EMOJI['date']} *–î–∞—Ç–∞:* {escape_markdown_v2(format_date_for_display(date.today()))}"
            )
            
            await message.answer(
                start_text,
                reply_markup=create_continue_keyboard(),
                parse_mode="MarkdownV2"
            )
            
    except Exception as e:
        bot_logger.error(f"Error starting journal entry for user {user_id}: {e}")
        await message.answer(
            format_error_message("general"),
            parse_mode="MarkdownV2"
        )


@router.callback_query(F.data.startswith("wj:"))
async def handle_journal_callback(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ –∂—É—Ä–Ω–∞–ª–∞ —Ä–∞–±–æ—Ç"""
    try:
        user_id = callback.from_user.id
        action, data = parse_callback_data(callback.data)
        
        async for session in get_async_session():
            service = WorkJournalService(session)
            user_state = await service.get_user_state(user_id)
            
            if not user_state:
                await callback.answer("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ —Å –∫–æ–º–∞–Ω–¥—ã /journal", show_alert=True)
                return
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è –ø–æ —Ç–∏–ø—É
            if action == CallbackAction.CONTINUE.value:
                await handle_continue_action(callback, session, service, user_state)
            
            elif action == CallbackAction.SELECT_TODAY.value:
                await handle_date_selection(callback, session, service, date.today())
            
            elif action == CallbackAction.SELECT_YESTERDAY.value:
                yesterday = date.today() - timedelta(days=1)
                await handle_date_selection(callback, session, service, yesterday)
            
            elif action == CallbackAction.SELECT_CUSTOM_DATE.value:
                await handle_custom_date_request(callback, session, service)
            
            elif action == CallbackAction.SELECT_DATE.value:
                await handle_return_to_date_selection(callback, session, service)
            
            elif action == CallbackAction.SELECT_COMPANY.value:
                await handle_company_selection(callback, session, service, data)
            
            elif action == CallbackAction.ADD_CUSTOM_COMPANY.value:
                await handle_custom_company_request(callback, session, service)
            
            elif action == CallbackAction.SELECT_DURATION.value:
                await handle_duration_selection(callback, session, service, data)
            
            elif action == CallbackAction.ADD_CUSTOM_DURATION.value:
                await handle_custom_duration_request(callback, session, service)
            
            elif action == CallbackAction.SELECT_TRAVEL_YES.value:
                await handle_travel_selection(callback, session, service, True)
            
            elif action == CallbackAction.SELECT_TRAVEL_NO.value:
                await handle_travel_selection(callback, session, service, False)
            
            elif action == CallbackAction.TOGGLE_WORKER.value:
                await handle_toggle_worker(callback, session, service, data)
            
            elif action == CallbackAction.CONFIRM_WORKERS.value:
                await handle_confirm_workers(callback, session, service)
            
            elif action == CallbackAction.SELECT_WORKER.value:
                # –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ - –æ–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä
                await handle_single_worker_selection(callback, session, service, data)
            
            elif action == CallbackAction.CONFIRM_SAVE.value:
                await handle_confirm_save(callback, session, service, user_state)
            
            elif action == CallbackAction.CANCEL.value:
                await handle_cancel_action(callback, session, service)
            
            elif action == CallbackAction.BACK.value:
                await handle_back_action(callback, session, service, user_state)
            
            else:
                await callback.answer("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ")
                
    except Exception as e:
        bot_logger.error(f"Error handling journal callback {callback.data} for user {user_id}: {e}")
        await callback.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", show_alert=True)


async def handle_continue_action(
    callback: CallbackQuery,
    session: AsyncSession, 
    service: WorkJournalService,
    user_state
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–π—Å—Ç–≤–∏—è '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å'"""
    if user_state.current_state == WorkJournalState.SELECTING_DATE.value:
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É –∫–æ–º–ø–∞–Ω–∏–∏
        companies = await service.get_companies()
        
        await service.set_user_state(
            callback.from_user.id,
            WorkJournalState.SELECTING_COMPANY
        )
        
        await callback.message.edit_text(
            MESSAGE_TEMPLATES['company_selection'],
            reply_markup=create_company_selection_keyboard(companies),
            parse_mode="MarkdownV2"
        )
        
        await callback.answer()
    
    elif user_state.current_state == WorkJournalState.ENTERING_DESCRIPTION.value:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–î–∞–ª–µ–µ" –±–µ–∑ –≤–≤–æ–¥–∞ –æ–ø–∏—Å–∞–Ω–∏—è, –ø—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç
        if not user_state.draft_description:
            await callback.answer("–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç!", show_alert=True)
            return
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É —Ç–∏–ø–∞ —Ä–∞–±–æ—Ç (–≤—ã–µ–∑–¥/—É–¥–∞–ª–µ–Ω–Ω–æ)
        await service.set_user_state(
            callback.from_user.id,
            WorkJournalState.SELECTING_TRAVEL
        )
        
        await callback.message.edit_text(
            MESSAGE_TEMPLATES['travel_selection'],
            reply_markup=create_travel_selection_keyboard(),
            parse_mode="MarkdownV2"
        )
        
        await callback.answer()


async def handle_date_selection(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService,
    selected_date: date
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã"""
    await service.set_user_state(
        callback.from_user.id,
        WorkJournalState.SELECTING_COMPANY,
        draft_date=selected_date
    )
    
    companies = await service.get_companies()
    
    await callback.message.edit_text(
        MESSAGE_TEMPLATES['company_selection'],
        reply_markup=create_company_selection_keyboard(companies),
        parse_mode="MarkdownV2"
    )
    
    await callback.answer(f"–í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞: {format_date_for_display(selected_date)}")


async def handle_company_selection(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService,
    company: str
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–∏"""
    await service.set_user_state(
        callback.from_user.id,
        WorkJournalState.SELECTING_DURATION,
        draft_company=company
    )
    
    await callback.message.edit_text(
        MESSAGE_TEMPLATES['duration_selection'],
        reply_markup=create_duration_selection_keyboard(),
        parse_mode="MarkdownV2"
    )
    
    await callback.answer(f"–í—ã–±—Ä–∞–Ω–∞ –∫–æ–º–ø–∞–Ω–∏—è: {company}")


async def handle_duration_selection(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService,
    duration: str
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
    await service.set_user_state(
        callback.from_user.id,
        WorkJournalState.ENTERING_DESCRIPTION,
        draft_duration=duration
    )
    
    await callback.message.edit_text(
        MESSAGE_TEMPLATES['description_prompt'],
        reply_markup=create_description_keyboard(),
        parse_mode="MarkdownV2"
    )
    
    await callback.answer(f"–í—ã–±—Ä–∞–Ω–æ –≤—Ä–µ–º—è: {duration}")


async def handle_travel_selection(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService,
    is_travel: bool
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Ä–∞–±–æ—Ç (–≤—ã–µ–∑–¥/—É–¥–∞–ª–µ–Ω–Ω–æ)"""
    await service.set_user_state(
        callback.from_user.id,
        WorkJournalState.SELECTING_WORKER,
        draft_is_travel=is_travel
    )
    
    workers = await service.get_workers()
    
    await callback.message.edit_text(
        MESSAGE_TEMPLATES['worker_selection'],
        reply_markup=create_worker_selection_keyboard(workers, []),  # –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
        parse_mode="MarkdownV2"
    )
    
    travel_text = "–≤—ã–µ–∑–¥" if is_travel else "—É–¥–∞–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞"
    await callback.answer(f"–í—ã–±—Ä–∞–Ω–æ: {travel_text}")


async def handle_worker_selection(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService,
    worker: str
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (DEPRECATED - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä)"""
    import json
    
    await service.set_user_state(
        callback.from_user.id,
        WorkJournalState.CONFIRMING_ENTRY,
        draft_workers=json.dumps([worker], ensure_ascii=False)
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    user_state = await service.get_user_state(callback.from_user.id)
    
    confirmation_text = format_draft_confirmation(user_state)
    
    await callback.message.edit_text(
        confirmation_text,
        reply_markup=create_confirmation_keyboard(),
        parse_mode="MarkdownV2"
    )
    
    await callback.answer(f"–í—ã–±—Ä–∞–Ω –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {worker}")


async def handle_confirm_save(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService,
    user_state
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
        if not all([
            user_state.draft_date,
            user_state.draft_company,
            user_state.draft_duration,
            user_state.draft_description,
            user_state.draft_workers,
            user_state.draft_is_travel is not None
        ]):
            await callback.answer("–ù–µ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã!", show_alert=True)
            return
        
        # –ü–∞—Ä—Å–∏–º —Å–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
        try:
            import json
            worker_names = json.loads(user_state.draft_workers)
            if not worker_names:
                await callback.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è!", show_alert=True)
                return
        except (json.JSONDecodeError, TypeError):
            await callback.answer("–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π!", show_alert=True)
            return
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ –∑–∞–ø–∏—Å–∏
        creator_name, user_email = await get_user_info(session, callback.from_user.id)
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –ë–î
        entry = await service.create_work_entry(
            telegram_user_id=callback.from_user.id,
            user_email=user_email,
            work_date=user_state.draft_date,
            company=user_state.draft_company,
            work_duration=user_state.draft_duration,
            work_description=user_state.draft_description,
            is_travel=user_state.draft_is_travel,
            worker_names=worker_names,
            created_by_user_id=callback.from_user.id,
            created_by_name=creator_name
        )
        
        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await service.clear_user_state(callback.from_user.id)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ n8n (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è n8n
            result = await session.execute(
                select(BotUser).where(BotUser.telegram_user_id == callback.from_user.id)
            )
            user = result.scalar_one_or_none()
            
            user_data = {
                "first_name": user.first_name if user else callback.from_user.first_name,
                "username": user.username if user else callback.from_user.username
            }
            
            n8n_service = N8nIntegrationService()
            await n8n_service.send_with_retry(entry, user_data, session)
            
        except Exception as e:
            bot_logger.error(f"Error sending to n8n for entry {entry.id}: {e}")
            # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å, —Ç–∞–∫ –∫–∞–∫ –∑–∞–ø–∏—Å—å —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –ë–î
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ —Å –¥–µ—Ç–∞–ª—è–º–∏
        workers_text = ", ".join(worker_names)
        work_date_str = entry.work_date.strftime('%d.%m.%Y') if entry.work_date else "–ù–µ —É–∫–∞–∑–∞–Ω–∞"
        
        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è MarkdownV2
        escaped_date = escape_markdown_v2(work_date_str)
        escaped_company = escape_markdown_v2(entry.company or '–ù–µ —É–∫–∞–∑–∞–Ω–∞')
        escaped_duration = escape_markdown_v2(entry.work_duration or '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
        escaped_workers = escape_markdown_v2(workers_text)
        escaped_creator = escape_markdown_v2(creator_name)
        
        success_message = (
            f"{format_success_message('created')}\n\n"
            f"*–î–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏:*\n"
            f"üìÖ –î–∞—Ç–∞: {escaped_date}\n"
            f"üè¢ –ö–æ–º–ø–∞–Ω–∏—è: {escaped_company}\n"
            f"‚è± –í—Ä–µ–º—è: {escaped_duration}\n"
            f"üë• –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: {escaped_workers}\n"
            f"üöó –¢–∏–ø: {'–í—ã–µ–∑–¥' if entry.is_travel else '–£–¥–∞–ª–µ–Ω–Ω–æ'}\n"
            f"üë§ –°–æ–∑–¥–∞–ª: {escaped_creator}"
        )
        
        await callback.message.edit_text(
            success_message,
            parse_mode="MarkdownV2"
        )
        
        log_user_action(callback.from_user.id, "journal_entry_created")
        await callback.answer("–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!")
        
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∏–∂–µ —á–µ—Ä–µ–∑ WorkerMentionService
        # —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç
        try:
            from ..services.worker_mention_service import WorkerMentionService
            from aiogram import Bot
            from ..config import settings
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω
            if settings.work_journal_group_chat_id:
                bot = Bot(token=settings.telegram_token)
                mention_service = WorkerMentionService(session, bot)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏
                success, errors = await mention_service.send_work_assignment_notifications(
                    entry, creator_name, settings.work_journal_group_chat_id
                )
                
                if errors:
                    for error in errors[:2]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 2 –æ—à–∏–±–∫–∏
                        bot_logger.warning(f"Group mention notification error: {error}")
                        
        except Exception as e:
            bot_logger.error(f"Error sending group mention notifications: {e}")
            # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å, —Ç–∞–∫ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
        
    except Exception as e:
        bot_logger.error(f"Error saving work entry: {e}")
        await callback.message.edit_text(
            format_error_message("general"),
            parse_mode="MarkdownV2"
        )
        await callback.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏!", show_alert=True)


async def handle_cancel_action(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã"""
    await service.clear_user_state(callback.from_user.id)
    
    await callback.message.edit_text(
        f"{EMOJI['cross']} –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ\\.",
        parse_mode="MarkdownV2"
    )
    
    await callback.answer("–û—Ç–º–µ–Ω–µ–Ω–æ")


async def handle_back_action(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService,
    user_state
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞–∑–∞–¥"""
    current_state = user_state.current_state
    
    if current_state == WorkJournalState.SELECTING_COMPANY.value:
        # –í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É –¥–∞—Ç—ã
        await service.set_user_state(
            callback.from_user.id,
            WorkJournalState.SELECTING_DATE
        )
        
        date_str = format_date_for_display(user_state.draft_date) if user_state.draft_date else format_date_for_display(date.today())
        start_text = (
            f"{MESSAGE_TEMPLATES['start_entry']}\n\n"
            f"{EMOJI['date']} **–î–∞—Ç–∞:** {escape_markdown_v2(date_str)}"
        )
        
        await callback.message.edit_text(
            start_text,
            reply_markup=create_continue_keyboard(),
            parse_mode="MarkdownV2"
        )
    
    elif current_state == WorkJournalState.SELECTING_DURATION.value:
        # –í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É –∫–æ–º–ø–∞–Ω–∏–∏
        companies = await service.get_companies()
        
        await service.set_user_state(
            callback.from_user.id,
            WorkJournalState.SELECTING_COMPANY
        )
        
        await callback.message.edit_text(
            MESSAGE_TEMPLATES['company_selection'],
            reply_markup=create_company_selection_keyboard(companies),
            parse_mode="MarkdownV2"
        )
    
    elif current_state == WorkJournalState.ENTERING_DESCRIPTION.value:
        # –í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        await service.set_user_state(
            callback.from_user.id,
            WorkJournalState.SELECTING_DURATION
        )
        
        await callback.message.edit_text(
            MESSAGE_TEMPLATES['duration_selection'],
            reply_markup=create_duration_selection_keyboard(),
            parse_mode="MarkdownV2"
        )
    
    elif current_state == WorkJournalState.SELECTING_TRAVEL.value:
        # –í–æ–∑–≤—Ä–∞—Ç –∫ –≤–≤–æ–¥—É –æ–ø–∏—Å–∞–Ω–∏—è
        await service.set_user_state(
            callback.from_user.id,
            WorkJournalState.ENTERING_DESCRIPTION
        )
        
        await callback.message.edit_text(
            MESSAGE_TEMPLATES['description_prompt'],
            reply_markup=create_description_keyboard(),
            parse_mode="MarkdownV2"
        )
    
    elif current_state == WorkJournalState.SELECTING_WORKER.value:
        # –í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É –≤—ã–µ–∑–¥–∞
        await service.set_user_state(
            callback.from_user.id,
            WorkJournalState.SELECTING_TRAVEL
        )
        
        await callback.message.edit_text(
            MESSAGE_TEMPLATES['travel_selection'],
            reply_markup=create_travel_selection_keyboard(),
            parse_mode="MarkdownV2"
        )
    
    elif current_state == WorkJournalState.CONFIRMING_ENTRY.value:
        # –í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
        workers = await service.get_workers()
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
        selected_workers = []
        if user_state.draft_workers:
            try:
                import json
                selected_workers = json.loads(user_state.draft_workers)
            except (json.JSONDecodeError, TypeError):
                pass
        
        await service.set_user_state(
            callback.from_user.id,
            WorkJournalState.SELECTING_WORKER
        )
        
        await callback.message.edit_text(
            MESSAGE_TEMPLATES['worker_selection'],
            reply_markup=create_worker_selection_keyboard(workers, selected_workers),
            parse_mode="MarkdownV2"
        )
    
    await callback.answer()


@router.message(Command("history", "work_history"))
async def show_work_history(message: Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–±–æ—Ç"""
    try:
        user_id = message.from_user.id
        log_user_action(user_id, "view_history")
        
        async for session in get_async_session():
            service = WorkJournalService(session)
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            entries = await service.get_work_entries(
                telegram_user_id=user_id,
                limit=10
            )
            
            if entries:
                text = format_entries_list(entries, "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏")
            else:
                text = f"*{EMOJI['history']} –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç*\n\n–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π\\. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –∫–æ–º–∞–Ω–¥–æ–π /journal\\."
            
            await message.answer(
                text,
                reply_markup=create_history_menu_keyboard(),
                parse_mode="MarkdownV2"
            )
            
    except Exception as e:
        bot_logger.error(f"Error showing work history for user {user_id}: {e}")
        await message.answer(
            format_error_message("general"),
            parse_mode="MarkdownV2"
        )


@router.message(Command("report", "work_report"))
async def show_work_reports(message: Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç—á–µ—Ç—ã –ø–æ —Ä–∞–±–æ—Ç–∞–º"""
    try:
        user_id = message.from_user.id
        log_user_action(user_id, "view_reports")
        
        async for session in get_async_session():
            service = WorkJournalService(session)
            
            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é
            week_ago = date.today() - timedelta(days=7)
            stats = await service.get_statistics(
                telegram_user_id=user_id,
                date_from=week_ago
            )
            
            report_text = format_statistics_report(stats, "–û—Ç—á–µ—Ç –∑–∞ –Ω–µ–¥–µ–ª—é")
            
            await message.answer(
                report_text,
                reply_markup=create_report_menu_keyboard(),
                parse_mode="MarkdownV2"
            )
            
    except Exception as e:
        bot_logger.error(f"Error showing work reports for user {user_id}: {e}")
        await message.answer(
            format_error_message("general"),
            parse_mode="MarkdownV2"
        )


async def handle_toggle_worker(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService,
    worker_name: str
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è"""
    user_state = await service.get_user_state(callback.from_user.id)
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
    selected_workers = []
    if user_state.draft_workers:
        try:
            import json
            selected_workers = json.loads(user_state.draft_workers)
        except (json.JSONDecodeError, TypeError):
            selected_workers = []
    
    # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤—ã–±–æ—Ä
    if worker_name in selected_workers:
        selected_workers.remove(worker_name)
    else:
        selected_workers.append(worker_name)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
    import json
    await service.set_user_state(
        callback.from_user.id,
        WorkJournalState.SELECTING_WORKER,
        draft_workers=json.dumps(selected_workers, ensure_ascii=False)
    )
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    workers = await service.get_workers()
    
    await callback.message.edit_text(
        MESSAGE_TEMPLATES['worker_selection'],
        reply_markup=create_worker_selection_keyboard(workers, selected_workers),
        parse_mode="MarkdownV2"
    )
    
    action_text = "–¥–æ–±–∞–≤–ª–µ–Ω" if worker_name in selected_workers else "—É–¥–∞–ª–µ–Ω"
    await callback.answer(f"{worker_name} {action_text}")


async def handle_confirm_workers(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π"""
    user_state = await service.get_user_state(callback.from_user.id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏
    selected_workers = []
    if user_state.draft_workers:
        try:
            import json
            selected_workers = json.loads(user_state.draft_workers)
        except (json.JSONDecodeError, TypeError):
            pass
    
    if not selected_workers:
        await callback.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è!", show_alert=True)
        return
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é –∑–∞–ø–∏—Å–∏
    await service.set_user_state(
        callback.from_user.id,
        WorkJournalState.CONFIRMING_ENTRY
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    user_state = await service.get_user_state(callback.from_user.id)
    
    confirmation_text = format_draft_confirmation(user_state)
    
    await callback.message.edit_text(
        confirmation_text,
        reply_markup=create_confirmation_keyboard(),
        parse_mode="MarkdownV2"
    )
    
    workers_count = len(selected_workers)
    await callback.answer(f"–í—ã–±—Ä–∞–Ω–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π: {workers_count}")


async def handle_single_worker_selection(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService,
    worker: str
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)"""
    import json
    
    await service.set_user_state(
        callback.from_user.id,
        WorkJournalState.CONFIRMING_ENTRY,
        draft_workers=json.dumps([worker], ensure_ascii=False)
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    user_state = await service.get_user_state(callback.from_user.id)
    
    confirmation_text = format_draft_confirmation(user_state)
    
    await callback.message.edit_text(
        confirmation_text,
        reply_markup=create_confirmation_keyboard(),
        parse_mode="MarkdownV2"
    )
    
    await callback.answer(f"–í—ã–±—Ä–∞–Ω –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {worker}")


async def get_user_info(session: AsyncSession, telegram_user_id: int) -> Tuple[str, str]:
    """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
    
    result = await session.execute(
        select(BotUser).where(BotUser.telegram_user_id == telegram_user_id)
    )
    user = result.scalar_one_or_none()
    
    if user:
        user_name = f"@{user.username}" if user.username else (user.first_name or f"User_{telegram_user_id}")
        user_email = f"{user.username}@example.com" if user.username else f"user_{telegram_user_id}@telegram.bot"
        return user_name, user_email
    
    return f"User_{telegram_user_id}", f"user_{telegram_user_id}@telegram.bot"


async def handle_custom_date_request(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–π –¥–∞—Ç—ã"""
    await service.set_user_state(
        callback.from_user.id,
        WorkJournalState.ENTERING_CUSTOM_DATE
    )
    
    await callback.message.edit_text(
        "üìÖ *–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î\\.–ú–ú\\.–ì–ì–ì–ì*\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: 25\\.07\\.2025",
        reply_markup=create_back_cancel_keyboard(),
        parse_mode="MarkdownV2"
    )
    
    await callback.answer()


async def handle_return_to_date_selection(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –≤—ã–±–æ—Ä—É –¥–∞—Ç—ã"""
    await service.set_user_state(
        callback.from_user.id,
        WorkJournalState.SELECTING_DATE
    )
    
    await callback.message.edit_text(
        MESSAGE_TEMPLATES['date_selection'],
        reply_markup=create_date_selection_keyboard(),
        parse_mode="MarkdownV2"
    )
    
    await callback.answer()


async def handle_custom_company_request(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏"""
    await service.set_user_state(
        callback.from_user.id,
        WorkJournalState.ENTERING_CUSTOM_COMPANY
    )
    
    await callback.message.edit_text(
        "üè¢ *–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏:*",
        parse_mode="MarkdownV2"
    )
    
    await callback.answer()


async def handle_custom_duration_request(
    callback: CallbackQuery,
    session: AsyncSession,
    service: WorkJournalService
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏"""
    await service.set_user_state(
        callback.from_user.id,
        WorkJournalState.ENTERING_CUSTOM_DURATION
    )
    
    await callback.message.edit_text(
        "‚è± *–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:*\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: 45 –º–∏–Ω, 2 —á–∞—Å–∞, 90 –º–∏–Ω",
        parse_mode="MarkdownV2"
    )
    
    await callback.answer()


# –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è work_journal
class IsWorkJournalActiveFilter:
    """
    –§–∏–ª—å—Ç—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è work_journal
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
    1. –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ work_journal
    2. –°–æ—Å—Ç–æ—è–Ω–∏–µ –ù–ï —Ä–∞–≤–Ω–æ 'idle' (idle = –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
    3. –°–æ—Å—Ç–æ—è–Ω–∏–µ –ù–ï —Ä–∞–≤–Ω–æ None
    """
    
    async def __call__(self, message: Message) -> bool:
        try:
            user_id = message.from_user.id
            
            async for session in get_async_session():
                service = WorkJournalService(session)
                user_state = await service.get_user_state(user_id)
                
                # –ù–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è = –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
                if not user_state or not user_state.current_state:
                    return False
                
                # idle = –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è work_journal
                if user_state.current_state == "idle":
                    return False
                
                # –õ–æ–≥–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                bot_logger.info(f"Work journal ACTIVE state for user {user_id}: {user_state.current_state}")
                return True
                
        except Exception as e:
            bot_logger.error(f"Error checking work_journal state for user {user_id}: {e}")
            return False
        
        return False


# –ì–õ–ê–í–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –¢–ï–ö–°–¢–û–í–û–ì–û –í–í–û–î–ê –î–õ–Ø WORK_JOURNAL
@router.message(F.text, IsWorkJournalActiveFilter())
async def handle_work_journal_text_input(message: Message):
    """
    –ì–õ–ê–í–ù–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è work_journal
    
    –†–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö:
    - –ù–ï idle
    - –ù–ï None
    - –õ—é–±–æ–µ –¥—Ä—É–≥–æ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ work_journal
    
    –≠—Ç–æ—Ç —Ñ–∏–ª—å—Ç—Ä –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–∑–æ–ª—è—Ü–∏—é –æ—Ç –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
    """
    try:
        user_id = message.from_user.id
        text = message.text.strip()
        
        bot_logger.info(f"Work journal text input: '{text}' from user {user_id}")
        
        async for session in get_async_session():
            service = WorkJournalService(session)
            user_state = await service.get_user_state(user_id)
            
            if not user_state or not user_state.current_state:
                bot_logger.warning(f"No active work_journal state for user {user_id}")
                return
            
            current_state = user_state.current_state
            bot_logger.info(f"Processing work_journal state: {current_state} for user {user_id}")
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
            if current_state == WorkJournalState.ENTERING_CUSTOM_DATE.value:
                await handle_custom_date_input(message, session, service, text)
            
            elif current_state == WorkJournalState.ENTERING_CUSTOM_COMPANY.value:
                await handle_custom_company_input(message, session, service, text)
            
            elif current_state == WorkJournalState.ENTERING_CUSTOM_DURATION.value:
                await handle_custom_duration_input(message, session, service, text)
            
            elif current_state == WorkJournalState.ENTERING_DESCRIPTION.value:
                await handle_description_input(message, session, service, text)
            
            elif current_state == WorkJournalState.ENTERING_CUSTOM_WORKER.value:
                await handle_custom_worker_input(message, session, service, text)
            
            else:
                bot_logger.warning(f"Unknown work_journal state: {current_state} for user {user_id}")
                await message.answer(
                    "‚ùå *–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ*\\n\\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /journal –¥–ª—è –Ω–∞—á–∞–ª–∞\\.",
                    parse_mode="MarkdownV2"
                )
            
    except Exception as e:
        bot_logger.error(f"Error in work_journal text handler for user {message.from_user.id}: {e}")
        await message.answer(
            format_error_message("general"),
            parse_mode="MarkdownV2"
        )


async def handle_custom_date_input(
    message: Message,
    session: AsyncSession,
    service: WorkJournalService,
    text: str
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–π –¥–∞—Ç—ã"""
    try:
        # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì
        from datetime import datetime, date
        parsed_date = datetime.strptime(text, "%d.%m.%Y").date()
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç—ã - —Ä–∞–∑—Ä–µ—à–∞–µ–º –ª—é–±—ã–µ –ø—Ä–æ—à–ª—ã–µ –¥–∞—Ç—ã, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –±—É–¥—É—â–µ–µ
        today = date.today()
        max_date = date(today.year + 1, 12, 31)  # –ú–∞–∫—Å–∏–º—É–º –Ω–∞ –≥–æ–¥ –≤–ø–µ—Ä–µ–¥
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–µ–¥–µ–ª (–Ω–µ —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –≤ –±—É–¥—É—â–µ–º)
        if parsed_date > max_date:
            max_date_str = max_date.strftime('%d\\.%m\\.%Y')
            today_str = today.strftime('%d\\.%m\\.%Y')
            await message.answer(
                f"‚ùå *–î–∞—Ç–∞ —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –≤ –±—É–¥—É—â–µ–º*\n\n–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞: {max_date_str}\n\n–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î\\.–ú–ú\\.–ì–ì–ì–ì \\(–Ω–∞–ø—Ä–∏–º–µ—Ä: {today_str}\\)",
                parse_mode="MarkdownV2"
            )
            return
        
        # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –æ—á–µ–Ω—å —Å—Ç–∞—Ä—ã—Ö –¥–∞—Ç (–Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º)
        if parsed_date < date(1990, 1, 1):
            parsed_date_str = parsed_date.strftime('%d\\.%m\\.%Y')
            await message.answer(
                f"‚ö†Ô∏è *–í–Ω–∏–º–∞–Ω–∏–µ*\n\n–í—ã –≤–≤–µ–ª–∏ –¥–∞—Ç—É –∏–∑ –¥–∞–ª–µ–∫–æ–≥–æ –ø—Ä–æ—à–ª–æ–≥–æ: {parsed_date_str}\n\n–ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∑–∞–ø–∏—Å—å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞\\.",
                parse_mode="MarkdownV2"
            )
        
        await service.set_user_state(
            message.from_user.id,
            WorkJournalState.SELECTING_COMPANY,
            draft_date=parsed_date
        )
        
        companies = await service.get_companies()
        
        await message.answer(
            MESSAGE_TEMPLATES['company_selection'],
            reply_markup=create_company_selection_keyboard(companies),
            parse_mode="MarkdownV2"
        )
        
    except ValueError:
        from datetime import date
        today = date.today()
        today_str = today.strftime('%d\\.%m\\.%Y')
        await message.answer(
            f"‚ùå *–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã*\n\n–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î\\.–ú–ú\\.–ì–ì–ì–ì \\(–Ω–∞–ø—Ä–∏–º–µ—Ä: {today_str}\\)",
            parse_mode="MarkdownV2"
        )


async def handle_custom_company_input(
    message: Message,
    session: AsyncSession,
    service: WorkJournalService,
    text: str
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏"""
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –∫–æ–º–ø–∞–Ω–∏—é
    await service.add_company(text)
    
    await service.set_user_state(
        message.from_user.id,
        WorkJournalState.SELECTING_DURATION,
        draft_company=text
    )
    
    await message.answer(
        MESSAGE_TEMPLATES['duration_selection'],
        reply_markup=create_duration_selection_keyboard(),
        parse_mode="MarkdownV2"
    )


async def handle_custom_duration_input(
    message: Message,
    session: AsyncSession,
    service: WorkJournalService,
    text: str
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"""
    user_id = message.from_user.id
    
    try:
        # –ü—ã—Ç–∞–µ–º—Å—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —á–∏—Å–ª–æ
        duration_minutes = int(text)
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞
        if duration_minutes <= 0:
            await message.answer(
                "‚ùå *–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è*\\n\\n–í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0 –º–∏–Ω—É—Ç\\.",
                parse_mode="MarkdownV2"
            )
            return
        
        if duration_minutes > 1440:  # 24 —á–∞—Å–∞
            await message.answer(
                "‚ùå *–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏*\\n\\n–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: 1440 –º–∏–Ω—É—Ç \\(24 —á–∞—Å–∞\\)\\.",
                parse_mode="MarkdownV2"
            )
            return
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
        if duration_minutes < 60:
            formatted_duration = f"{duration_minutes} –º–∏–Ω"
        else:
            hours = duration_minutes // 60
            minutes = duration_minutes % 60
            if minutes == 0:
                formatted_duration = f"{hours} —á"
            else:
                formatted_duration = f"{hours} —á {minutes} –º–∏–Ω"
        
        await service.set_user_state(
            user_id,
            WorkJournalState.ENTERING_DESCRIPTION,
            draft_duration=formatted_duration
        )
        
        await message.answer(
            MESSAGE_TEMPLATES['description_prompt'],
            reply_markup=create_description_input_keyboard(),
            parse_mode="MarkdownV2"
        )
        
    except ValueError:
        await message.answer(
            "‚ùå *–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏*\\n\\n–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö \\(—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\\)\\n\\n–ü—Ä–∏–º–µ—Ä: 60, 120, 180",
            parse_mode="MarkdownV2"
        )


async def handle_description_input(
    message: Message,
    session: AsyncSession,
    service: WorkJournalService,
    text: str
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –æ–ø–∏—Å–∞–Ω–∏—è —Ä–∞–±–æ—Ç"""
    await service.set_user_state(
        message.from_user.id,
        WorkJournalState.SELECTING_TRAVEL,
        draft_description=text
    )
    
    await message.answer(
        MESSAGE_TEMPLATES['travel_selection'],
        reply_markup=create_travel_selection_keyboard(),
        parse_mode="MarkdownV2"
    )


async def handle_custom_worker_input(
    message: Message,
    session: AsyncSession,
    service: WorkJournalService,
    text: str
):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è"""
    user_id = message.from_user.id
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
    await service.add_worker(text)
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º
    user_state = await service.get_user_state(user_id)
    
    selected_workers = []
    if user_state.draft_workers:
        try:
            import json
            selected_workers = json.loads(user_state.draft_workers)
        except (json.JSONDecodeError, TypeError):
            selected_workers = []
    
    if text not in selected_workers:
        selected_workers.append(text)
    
    import json
    await service.set_user_state(
        user_id,
        WorkJournalState.CONFIRMING_ENTRY,
        draft_workers=json.dumps(selected_workers, ensure_ascii=False)
    )
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    user_state = await service.get_user_state(user_id)
    confirmation_text = format_draft_confirmation(user_state)
    
    await message.answer(
        confirmation_text,
        reply_markup=create_confirmation_keyboard(),
        parse_mode="MarkdownV2"
    )


async def show_confirmation(
    message: Message,
    session: AsyncSession,
    service: WorkJournalService,
    user_state
):
    """–ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
    confirmation_text = format_confirmation_message(
        user_state.draft_date,
        user_state.draft_company,
        user_state.draft_duration,
        user_state.draft_description,
        user_state.draft_is_travel,
        user_state.draft_workers or []
    )
    
    await message.answer(
        confirmation_text,
        reply_markup=create_confirmation_keyboard(),
        parse_mode="MarkdownV2"
    )



# –ö–æ–º–∞–Ω–¥–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏—è–º–∏
@router.message(Command("companies", "manage_companies"))
async def manage_companies(message: Message):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º –∫–æ–º–ø–∞–Ω–∏–π"""
    try:
        user_id = message.from_user.id
        log_user_action(user_id, "manage_companies")
        
        async for session in get_async_session():
            service = WorkJournalService(session)
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–ø–∞–Ω–∏–π
            companies = await service.get_companies()
            
            if not companies:
                await message.answer(
                    "üìã *–°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –ø—É—Å—Ç*\n\n–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π –≤ –∂—É—Ä–Ω–∞–ª–µ —Ä–∞–±–æ—Ç\\.",
                    parse_mode="MarkdownV2"
                )
                return
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ —Å–ø–∏—Å–∫–æ–º –∫–æ–º–ø–∞–Ω–∏–π
            companies_text = "üìã *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏—è–º–∏*\n\n"
            companies_text += "*–¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫:*\n"
            
            for i, company in enumerate(companies, 1):
                companies_text += f"{i}\\. {escape_markdown_v2(company)}\n"
            
            companies_text += "\nüí° *–ö–∞–∫ —É–ø—Ä–∞–≤–ª—è—Ç—å:*\n"
            companies_text += "‚Ä¢ –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: `/delete_company –ù–∞–∑–≤–∞–Ω–∏–µ`\n"
            companies_text += "‚Ä¢ –ù–æ–≤—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π\n"
            companies_text += "‚Ä¢ –ü—Ä–∏–º–µ—Ä —É–¥–∞–ª–µ–Ω–∏—è: `/delete_company Test`"
            
            await message.answer(
                companies_text,
                parse_mode="MarkdownV2"
            )
            
    except Exception as e:
        bot_logger.error(f"Error managing companies for user {user_id}: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π.")


@router.message(Command("delete_company"))
async def delete_company(message: Message):
    """–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞"""
    try:
        user_id = message.from_user.id
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ –∫–æ–º–∞–Ω–¥—ã
        command_parts = message.text.split(maxsplit=1)
        if len(command_parts) < 2:
            await message.answer(
                "‚ùå *–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏*\n\n–ü—Ä–∏–º–µ—Ä: `/delete_company Test`\n\n–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞: `/companies`",
                parse_mode="MarkdownV2"
            )
            return
        
        company_name = command_parts[1].strip()
        log_user_action(user_id, f"delete_company_{company_name}")
        
        async for session in get_async_session():
            service = WorkJournalService(session)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–æ–º–ø–∞–Ω–∏—è
            companies = await service.get_companies()
            if company_name not in companies:
                await message.answer(
                    f"‚ùå *–ö–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞*\n\n–ö–æ–º–ø–∞–Ω–∏—è \"{escape_markdown_v2(company_name)}\" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ\\.\n\n–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞: `/companies`",
                    parse_mode="MarkdownV2"
                )
                return
            
            # –£–¥–∞–ª—è–µ–º –∫–æ–º–ø–∞–Ω–∏—é
            success, result = await service.delete_company(company_name)
            
            if success:
                await message.answer(
                    f"‚úÖ *–ö–æ–º–ø–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–∞*\n\n–ö–æ–º–ø–∞–Ω–∏—è \"{escape_markdown_v2(company_name)}\" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞\\.",
                    parse_mode="MarkdownV2"
                )
                log_user_action(user_id, f"company_deleted_{company_name}")
            elif result == "not_found":
                await message.answer(
                    f"‚ùå *–ö–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞*\n\n–ö–æ–º–ø–∞–Ω–∏—è \"{escape_markdown_v2(company_name)}\" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ\\.\n\n–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞: `/companies`",
                    parse_mode="MarkdownV2"
                )
            elif result.startswith("used_in_"):
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                entries_count = result.split("_")[-2]  # used_in_1_entries -> 1
                await message.answer(
                    f"‚ùå *–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é*\n\n"
                    f"–ö–æ–º–ø–∞–Ω–∏—è \"{escape_markdown_v2(company_name)}\" –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ *{entries_count}* –∑–∞–ø–∏—Å—è—Ö –∂—É—Ä–Ω–∞–ª–∞ —Ä–∞–±–æ—Ç\\.\n\n"
                    f"üí° *–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:*\n"
                    f"‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø–∏—Å–∏: `/history`\n"
                    f"‚Ä¢ –ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å–∏ —Å —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–µ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏\n"
                    f"‚Ä¢ –ö–æ–º–ø–∞–Ω–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π",
                    parse_mode="MarkdownV2"
                )
            else:
                await message.answer(
                    f"‚ùå *–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è*\n\n–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏ \"{escape_markdown_v2(company_name)}\"\\.",
                    parse_mode="MarkdownV2"
                )
            
    except Exception as e:
        bot_logger.error(f"Error deleting company for user {user_id}: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏.")


@router.message(Command("force_delete_company"))
async def force_delete_company(message: Message):
    """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ —Å–æ –≤—Å–µ–º–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏"""
    try:
        user_id = message.from_user.id
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ –∫–æ–º–∞–Ω–¥—ã
        command_parts = message.text.split(maxsplit=1)
        if len(command_parts) < 2:
            await message.answer(
                "‚ùå *–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏*\n\n"
                "‚ö†Ô∏è *–í–ù–ò–ú–ê–ù–ò–ï\\!* –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —É–¥–∞–ª–∏—Ç –∫–æ–º–ø–∞–Ω–∏—é –∏ –í–°–ï —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏\\!\n\n"
                "–ü—Ä–∏–º–µ—Ä: `/force_delete_company Test`\n\n"
                "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞: `/companies`",
                parse_mode="MarkdownV2"
            )
            return
        
        company_name = command_parts[1].strip()
        log_user_action(user_id, f"force_delete_company_{company_name}")
        
        async for session in get_async_session():
            service = WorkJournalService(session)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–æ–º–ø–∞–Ω–∏—è
            companies = await service.get_companies()
            if company_name not in companies:
                await message.answer(
                    f"‚ùå *–ö–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞*\n\n–ö–æ–º–ø–∞–Ω–∏—è \"{escape_markdown_v2(company_name)}\" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ\\.\n\n–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞: `/companies`",
                    parse_mode="MarkdownV2"
                )
                return
            
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
            entries_count_result = await session.execute(
                select(func.count(WorkJournalEntry.id)).where(WorkJournalEntry.company == company_name)
            )
            entries_count = entries_count_result.scalar()
            
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–µ–π
            if entries_count > 0:
                await session.execute(
                    delete(WorkJournalEntry).where(WorkJournalEntry.company == company_name)
                )
            
            # –£–¥–∞–ª—è–µ–º –∫–æ–º–ø–∞–Ω–∏—é
            await session.execute(
                delete(WorkJournalCompany).where(WorkJournalCompany.name == company_name)
            )
            
            await session.commit()
            
            if entries_count > 0:
                await message.answer(
                    f"‚úÖ *–ö–æ–º–ø–∞–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ —É–¥–∞–ª–µ–Ω—ã*\n\n"
                    f"–ö–æ–º–ø–∞–Ω–∏—è \"{escape_markdown_v2(company_name)}\" —É–¥–∞–ª–µ–Ω–∞ –≤–º–µ—Å—Ç–µ —Å *{entries_count}* –∑–∞–ø–∏—Å—è–º–∏\\.",
                    parse_mode="MarkdownV2"
                )
                log_user_action(user_id, f"force_deleted_company_{company_name}_with_{entries_count}_entries")
            else:
                await message.answer(
                    f"‚úÖ *–ö–æ–º–ø–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–∞*\n\n–ö–æ–º–ø–∞–Ω–∏—è \"{escape_markdown_v2(company_name)}\" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞\\.",
                    parse_mode="MarkdownV2"
                )
                log_user_action(user_id, f"force_deleted_company_{company_name}")
            
    except Exception as e:
        bot_logger.error(f"Error force deleting company for user {user_id}: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏.")
