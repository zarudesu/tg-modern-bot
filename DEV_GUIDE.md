# üîß –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ - –ú–û–î–£–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–û–°–õ–ï –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê

### üìÅ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:**
```
app/
‚îú‚îÄ‚îÄ modules/           # üéØ –ì–õ–ê–í–ù–´–ï –ú–û–î–£–õ–ò –ë–û–¢–ê (–æ—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
‚îÇ   ‚îú‚îÄ‚îÄ daily_tasks/   # ‚úÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ (email –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
‚îÇ   ‚îú‚îÄ‚îÄ work_journal/  # ‚úÖ –ñ—É—Ä–Ω–∞–ª —Ä–∞–±–æ—Ç (—Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
‚îÇ   ‚îî‚îÄ‚îÄ your_module/   # üÜï –ù–û–í–´–ï –ú–û–î–£–õ–ò –°–û–ó–î–ê–í–ê–¢–¨ –ó–î–ï–°–¨
‚îú‚îÄ‚îÄ handlers/          # üîß –û–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (start, help, admin)
‚îú‚îÄ‚îÄ services/          # üíº –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ database/          # üóÑÔ∏è –ú–æ–¥–µ–ª–∏ –ë–î
‚îú‚îÄ‚îÄ middleware/        # üîß –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û
‚îú‚îÄ‚îÄ utils/            # üõ†Ô∏è –£—Ç–∏–ª–∏—Ç—ã –∏ –ø–æ–º–æ—â–Ω–∏–∫–∏
‚îî‚îÄ‚îÄ integrations/     # üîó –í–Ω–µ—à–Ω–∏–µ API
```

### üéØ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ù–¶–ò–ü–´:**
1. **–ò–∑–æ–ª—è—Ü–∏—è –º–æ–¥—É–ª–µ–π** - –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
2. **–§–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤** - email ‚Üí daily_tasks, —Ç–µ–∫—Å—Ç –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚Üí work_journal
3. **–ü–æ—Ä—è–¥–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏** - –≤ main.py –ø–æ—Ä—è–¥–æ–∫ —Ä–æ—É—Ç–µ—Ä–æ–≤ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
4. **–°–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–¥—É–ª–µ–π** - –∏—Å–ø–æ–ª—å–∑—É–π –ë–î –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π

## üÜï –°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ì–û –ú–û–î–£–õ–Ø

### **–®–∞–≥ 1: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è**
```
app/modules/your_module/
‚îú‚îÄ‚îÄ __init__.py        # –≠–∫—Å–ø–æ—Ä—Ç router
‚îú‚îÄ‚îÄ router.py          # üéØ –ì–õ–ê–í–ù–´–ô —Ä–æ—É—Ç–µ—Ä (–ø–æ–¥–∫–ª—é—á–∞–µ—Ç –≤—Å–µ)
‚îú‚îÄ‚îÄ handlers.py        # üìã –ö–æ–º–∞–Ω–¥—ã (/your_command)
‚îú‚îÄ‚îÄ filters.py         # üîç –§–∏–ª—å—Ç—Ä—ã –∏–∑–æ–ª—è—Ü–∏–∏ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)
‚îú‚îÄ‚îÄ text_handlers.py   # üìù –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏)
‚îî‚îÄ‚îÄ callback_handlers.py # üéõ –ö–Ω–æ–ø–∫–∏ –∏ –∫–æ–ª–ª–±—ç–∫–∏
```

### **–®–∞–≥ 2: –®–∞–±–ª–æ–Ω –º–æ–¥—É–ª—è**

**`__init__.py`:**
```python
from .router import router
__all__ = ['router']
```

**`router.py`:**
```python
from aiogram import Router
from .handlers import router as handlers_router
from .text_handlers import router as text_router
from .callback_handlers import router as callback_router

router = Router()

# –ü–û–†–Ø–î–û–ö –í–ê–ñ–ï–ù:
router.include_router(handlers_router)     # –ö–æ–º–∞–Ω–¥—ã –ø–µ—Ä–≤—ã–µ
router.include_router(callback_router)     # –ö–æ–ª–ª–±—ç–∫–∏ –≤—Ç–æ—Ä—ã–µ  
router.include_router(text_router)         # –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π
```

**`filters.py`:**
```python
from aiogram.filters import BaseFilter
from aiogram.types import Message
from ...database.database import get_async_session

class YourModuleActiveFilter(BaseFilter):
    """–§–∏–ª—å—Ç—Ä –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–¥—É–ª—è"""
    
    async def __call__(self, message: Message) -> bool:
        user_id = message.from_user.id
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ë–î
        async for session in get_async_session():
            # –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ—é –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            user_state = await get_user_state(session, user_id, 'your_module')
            return user_state and user_state.active
```

**`handlers.py`:**
```python
from aiogram import Router
from aiogram.types import Message
from aiogram.filters import Command

router = Router()

@router.message(Command("your_command"))
async def your_command_handler(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ –≤–∞—à–µ–≥–æ –º–æ–¥—É–ª—è"""
    await message.reply("üéØ –í–∞—à –º–æ–¥—É–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç!")
```

**`text_handlers.py`:**
```python
from aiogram import Router, F
from aiogram.types import Message
from .filters import YourModuleActiveFilter

router = Router()

@router.message(F.text, YourModuleActiveFilter())
async def handle_text_input(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏"""
    text = message.text.strip()
    
    # –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞
    await message.reply(f"üìù –ü–æ–ª—É—á–µ–Ω —Ç–µ–∫—Å—Ç: {text}")
```

### **–®–∞–≥ 3: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ main.py**
```python
# –í app/main.py –¥–æ–±–∞–≤–∏—Ç—å:
from .modules.your_module.router import router as your_module_router

# –í —Ñ—É–Ω–∫—Ü–∏–∏ main():
dp.include_router(your_module_router)
```

## üîç –§–ò–õ–¨–¢–†–´ –ò–ó–û–õ–Ø–¶–ò–ò

### **–¢–∏–ø—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤:**

**Email —Ñ–∏–ª—å—Ç—Ä (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):**
```python
class EmailFilter(BaseFilter):
    async def __call__(self, message: Message) -> bool:
        return bool(re.match(r'^[^@]+@[^@]+\.[^@]+$', message.text or ''))
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:**
```python
class ActiveStateFilter(BaseFilter):
    async def __call__(self, message: Message) -> bool:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥—É–ª—è
        user_id = message.from_user.id
        return await check_active_state(user_id, 'module_name')
```

**–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä:**
```python
class AdminEmailFilter(BaseFilter):
    async def __call__(self, message: Message) -> bool:
        return (is_email(message.text) and 
                is_admin(message.from_user.id))
```

## üìä –ü–†–ò–ú–ï–†–´ –ì–û–¢–û–í–´–• –ú–û–î–£–õ–ï–ô

### **daily_tasks –º–æ–¥—É–ª—å:**
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –í—ã—Å—à–∏–π (email –∞–¥–º–∏–Ω–æ–≤)
- **–§–∏–ª—å—Ç—Ä**: `IsAdminEmailFilter` 
- **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç**: email –æ—Ç –∞–¥–º–∏–Ω–æ–≤ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Plane

### **work_journal –º–æ–¥—É–ª—å:**
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ù–∏–∑–∫–∏–π (—Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
- **–§–∏–ª—å—Ç—Ä**: `IsWorkJournalActiveFilter`
- **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç**: —Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö –∂—É—Ä–Ω–∞–ª–∞

## üöÄ –î–ï–ü–õ–û–ô –ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### **–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞:**
```bash
make dev              # –ó–∞–ø—É—Å–∫ –≤ dev —Ä–µ–∂–∏–º–µ
make dev-restart      # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
```

### **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è:**
```bash
python test_your_module.py  # –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç –º–æ–¥—É–ª—è
python test_isolation.py    # –¢–µ—Å—Ç –∏–∑–æ–ª—è—Ü–∏–∏
```

### **–ü—Ä–æ–¥–∞–∫—à–Ω:**
```bash
make prod-deploy      # –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
```

## üõ°Ô∏è –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê

1. **–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–∏–ª—å—Ç—Ä—ã** - –º–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
2. **–ü–æ—Ä—è–¥–æ–∫ —Ä–æ—É—Ç–µ—Ä–æ–≤ –≤–∞–∂–µ–Ω** - –ø–µ—Ä–≤—ã–π –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
3. **–¢–µ—Å—Ç–∏—Ä—É–π –∏–∑–æ–ª—è—Ü–∏—é** - —É–±–µ–¥–∏—Å—å —á—Ç–æ –º–æ–¥—É–ª–∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç
4. **–°–æ—Å—Ç–æ—è–Ω–∏—è –≤ –ë–î** - –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
5. **–ê—Ä—Ö–∏–≤–∏—Ä—É–π —Å—Ç–∞—Ä–æ–µ** - –Ω–µ —É–¥–∞–ª—è–π, –∞ –ø–µ—Ä–µ–º–µ—â–∞–π –≤ archive/

## üìù –ß–ï–ö–õ–ò–°–¢ –ù–û–í–û–ì–û –ú–û–î–£–õ–Ø

- [ ] –°–æ–∑–¥–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫ –≤ `app/modules/your_module/`
- [ ] –ù–∞–ø–∏—Å–∞–Ω `router.py` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ—Ä—è–¥–∫–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- [ ] –°–æ–∑–¥–∞–Ω—ã —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑–æ–ª—è—Ü–∏–∏ –≤ `filters.py`
- [ ] –ö–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ `handlers.py`
- [ ] –¢–µ–∫—Å—Ç–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –≤ `text_handlers.py`
- [ ] –ü–æ–¥–∫–ª—é—á–µ–Ω —Ä–æ—É—Ç–µ—Ä –≤ `main.py`
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑–æ–ª—è—Ü–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
- [ ] –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç –º–æ–¥—É–ª—è
