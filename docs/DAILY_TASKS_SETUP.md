# Daily Tasks Module - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è

Daily Tasks - —ç—Ç–æ –º–æ–¥—É–ª—å –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–¥–∞—á –∏–∑ Plane API –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º Telegram –±–æ—Ç–∞. 

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- üìß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ email –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Plane API
- ‚è∞ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- üîî –í–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- üìã –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–∏—Ö –∑–∞–¥–∞—á –∏–∑ Plane
- üõ†Ô∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Plane API

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

```
app/modules/daily_tasks/
‚îú‚îÄ‚îÄ __init__.py           # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
‚îú‚îÄ‚îÄ handlers.py           # –ö–æ–º–∞–Ω–¥—ã (/daily_tasks, /daily_settings, /plane_test)
‚îú‚îÄ‚îÄ callback_handlers.py  # Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
‚îú‚îÄ‚îÄ email_handlers.py     # –û–±—Ä–∞–±–æ—Ç–∫–∞ email –≤–≤–æ–¥–∞
‚îî‚îÄ‚îÄ filters.py           # –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –º–æ–¥—É–ª—è
```

### –°–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- `app/services/daily_tasks_service.py` - –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
- `app/integrations/plane_api.py` - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Plane API
- `app/database/daily_tasks_models.py` - –ú–æ–¥–µ–ª–∏ –ë–î

## üöÄ –ö–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### `/daily_tasks`
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ –∞–¥–º–∏–Ω–∞ –∏–∑ Plane
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ Plane API
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–æ 5 –∑–∞–¥–∞—á —Å –∏–∫–æ–Ω–∫–∞–º–∏ —Å—Ç–∞—Ç—É—Å–∞
- –ö–Ω–æ–ø–∫–∏: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏", "–û–±–Ω–æ–≤–∏—Ç—å"

### `/daily_settings` 
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- üìß Email –∞–¥—Ä–µ—Å (–¥–ª—è Plane API)
- ‚è∞ –í—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (09:00, 10:00, 11:00)
- üîî –í–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- üìã –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏

### `/plane_test`
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Plane API
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é API —Ç–æ–∫–µ–Ω–∞
- –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Plane —Å–µ—Ä–≤–µ—Ä–∞
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏:

```python
class IsAdminEmailFilter(BaseFilter):
    """–§–∏–ª—å—Ç—Ä email –¢–û–õ–¨–ö–û –æ—Ç –∞–¥–º–∏–Ω–æ–≤ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤–≤–æ–¥–∞ email"""
    
    async def __call__(self, message: Message) -> bool:
        # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∞
        # –ò –∞–¥–º–∏–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤–≤–æ–¥–∞ email
        # –ò —Ç–µ–∫—Å—Ç –ø–æ—Ö–æ–∂ –Ω–∞ email
        return is_valid_email and is_admin_waiting_for_email
```

### MarkdownV2 –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:

```python
def escape_markdown_v2(text: str) -> str:
    chars_to_escape = ['_', '*', '[', ']', '(', ')', '~', '`', '>', 
                      '#', '+', '-', '=', '|', '{', '}', '.', '!', '@']
    for char in chars_to_escape:
        text = text.replace(char, f'\\\\{char}')
    return text
```

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
–í—Ä–µ–º—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ Python time –æ–±—ä–µ–∫—Ç –¥–ª—è PostgreSQL:

```python
from datetime import time as time_obj
hour, minute = map(int, time_str.split(':'))
time_object = time_obj(hour, minute)
```

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ admin_daily_tasks_settings
```sql
CREATE TABLE admin_daily_tasks_settings (
    id SERIAL PRIMARY KEY,
    telegram_user_id BIGINT NOT NULL,
    plane_email VARCHAR(255),
    enabled BOOLEAN DEFAULT false,
    notification_time TIME,
    timezone VARCHAR(50) DEFAULT 'Europe/Moscow',
    include_overdue BOOLEAN DEFAULT true,
    include_today BOOLEAN DEFAULT true,
    include_upcoming BOOLEAN DEFAULT true,
    group_by_project BOOLEAN DEFAULT true,
    max_tasks_per_section INTEGER DEFAULT 5,
    created_at TIMESTAMP DEFAULT now(),
    updated_at TIMESTAMP DEFAULT now(),
    last_sent_at TIMESTAMP
);
```

## üéõÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
```bash
# Plane API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
PLANE_API_TOKEN=your_plane_api_token_here
PLANE_BASE_URL=https://your-plane-instance.com
PLANE_WORKSPACE_SLUG=your-workspace-slug

# Daily Tasks –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
DAILY_TASKS_ENABLED=true
DAILY_TASKS_TIME=10:00
DAILY_TASKS_TIMEZONE=Europe/Moscow

# Admin IDs (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
ADMIN_USER_ID_LIST=28795547,123456789
```

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è daily_tasks_service
**–ü—Ä–æ–±–ª–µ–º–∞:** `daily_tasks_service = None` –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ email_handlers.py:
```python
if daily_tasks_service is None:
    bot_logger.error("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    return
```

### 2. –§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤ –ë–î
**–ü—Ä–æ–±–ª–µ–º–∞:** PostgreSQL –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤—Ä–µ–º–µ–Ω–∏
**–†–µ—à–µ–Ω–∏–µ:** –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ time –æ–±—ä–µ–∫—Ç:
```python
from datetime import time as time_obj
time_object = time_obj(hour, minute)
```

### 3. MarkdownV2 —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏–º–≤–æ–ª—ã –Ω–µ —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
**–†–µ—à–µ–Ω–∏–µ:** –î–≤–æ–π–Ω–æ–π backslash `\\\\` –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
./venv/bin/python test_daily_tasks_comprehensive.py
```

### –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
1. ‚úÖ –ò–º–ø–æ—Ä—Ç—ã –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
2. ‚úÖ MarkdownV2 —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
3. ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
4. ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DailyTasksService

## üîç –û—Ç–ª–∞–¥–∫–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
```
üéØ ADMIN EMAIL HANDLER TRIGGERED: email from admin_id
‚úÖ Daily tasks service –Ω–∞–π–¥–µ–Ω: <class 'DailyTasksService'>
üìù –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è admin
üìß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º email –¥–ª—è admin
‚è∞ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏ –≤—Ä–µ–º—è –≤ time –æ–±—ä–µ–∫—Ç
üíæ –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î...
‚úÖ Admin settings saved to database successfully
```

### –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏:
1. `daily_tasks_service = None` - —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
2. `'str' object has no attribute 'hour'` - –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏
3. `Character '.' is reserved` - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ MarkdownV2 —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

## üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] `daily_tasks_service` –Ω–µ —Ä–∞–≤–µ–Ω None
- [ ] Email —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –í—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ time –æ–±—ä–µ–∫—Ç
- [ ] MarkdownV2 —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] Plane API –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ó–∞–¥–∞—á–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ Plane
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ

## üéâ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è –∞–¥–º–∏–Ω–∞ (ID: 28795547):
1. `/start` - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º
2. "üìÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–¥–∞—á" - –ü–µ—Ä–µ—Ö–æ–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
3. "üìß Email –∞–¥—Ä–µ—Å" - –í–≤–æ–¥ email –¥–ª—è Plane
4. "‚è∞ –í—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π" - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
5. "üîî –í–∫–ª/–í—ã–∫–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" - –í–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
6. "üìã –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞—á–∏" - –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–∏—Ö –∑–∞–¥–∞—á

### –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ flow:
```
Admin ‚Üí /start ‚Üí –ö–Ω–æ–ø–∫–∞ "üìÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–¥–∞—á" ‚Üí 
"üìß Email –∞–¥—Ä–µ—Å" ‚Üí –í–≤–æ–¥ "zarudesu@gmail.com" ‚Üí 
"‚è∞ –í—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π" ‚Üí –í—ã–±–æ—Ä "üïô 10:00" ‚Üí 
"üîî –í–∫–ª/–í—ã–∫–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" ‚Üí –í–∫–ª—é—á–∏—Ç—å ‚Üí 
"üìã –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞—á–∏" ‚Üí –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á –∏–∑ Plane
```

–ú–æ–¥—É–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É! üöÄ